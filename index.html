<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stacktome Recommendations</title>
    <style>
        .recs-wrapper { max-width:350px; margin:30px auto; }
        .offer-card { box-shadow:0 2px 8px #0001; border-radius:8px; overflow:hidden; font-family:Arial,sans-serif; background:#fff; }
        .carousel { position:relative; height:220px; overflow:hidden; }
        .carousel img { width:100%; height:220px; object-fit:cover;}
        .carousel-btn { position:absolute; top:50%; transform:translateY(-50%); background:#fff8; border:0; width:32px; height:32px; border-radius:50%; font-size:22px; cursor:pointer; z-index:2;}
        .carousel-btn.prev { left:8px; }
        .carousel-btn.next { right:8px; }
        .dots { position:absolute; left:50%; bottom:12px; transform:translateX(-50%); display:flex; gap:6px;}
        .dot { width:9px; height:9px; border-radius:50%; background:#fff8; border:1px solid #888; cursor:pointer;}
        .dot.active { background:#222; }
        .offer-header { display:flex; justify-content:space-between; align-items:center; padding:10px 15px;}
        .offer-title { font-weight:bold; font-size:17px; }
        .offer-rating { font-size:13px; color:#C90;}
        .offer-desc { padding: 0 15px 10px 15px; font-size:15px; color:#333;}
        .offer-price { font-weight:bold; font-size:18px; color:#2976FF; padding:0 0 10px 15px;}
        .offer-oldprice { color:#aaa; text-decoration:line-through; margin-left:10px; font-size:14px;}
        .offer-action { display:flex; gap:8px; padding:12px 15px 15px 15px;}
        .offer-action button { flex:1; padding:8px 0; border-radius:5px; border:0; cursor:pointer; font-weight:bold;}
        .buy-btn { background:#2976FF; color:#fff; }
        .next-btn { background:#fff; border:1.5px solid #2976FF; color:#2976FF;}
        .badge { position:absolute; top:10px; left:10px; background:#e33; color:#fff; border-radius:4px; padding:3px 7px;font-size: 13px;}
        .expire { position:absolute; top:10px; right:10px; background:#222a; color:#fff; border-radius:4px; padding:3px 7px;font-size: 13px;}
    </style>
</head>
<body>
<h2>Stacktome Recommendations DEMO</h2>
<form id="recForm">
    <label>Email <input type="email" name="email" required></label>
    <label>OrderId <input name="orderId" required></label>
    <label>SKU <input name="sku" required></label>
    <button type="submit">Get recommendations</button>
</form>
<div id="output"></div>
<script>
function renderOffers(offers){
    let offerIdx = 0;
    const wrapper = document.createElement('div');
    wrapper.className = 'recs-wrapper';
    function show(idx) {
        const offer = offers[idx];
        wrapper.innerHTML = '';
        const card = document.createElement('div');
        card.className = 'offer-card';
        let imgIdx = 0;
        const carousel = document.createElement('div');
        carousel.className = 'carousel';
        const img = document.createElement('img');
        img.src = offer.productImages[imgIdx] || '';
        carousel.appendChild(img);
        if (offer.productImages.length > 1) {
            const btnPrev = document.createElement('button');
            btnPrev.className = 'carousel-btn prev';
            btnPrev.textContent = '←';
            btnPrev.onclick = ()=> { imgIdx = (imgIdx-1+offer.productImages.length)%offer.productImages.length; img.src = offer.productImages[imgIdx]; updateDots(); }
            carousel.appendChild(btnPrev);
            const btnNext = document.createElement('button');
            btnNext.className = 'carousel-btn next';
            btnNext.textContent = '→';
            btnNext.onclick = ()=> { imgIdx = (imgIdx+1)%offer.productImages.length; img.src = offer.productImages[imgIdx]; updateDots(); }
            carousel.appendChild(btnNext);
        }
        const dotsWrap = document.createElement('div');
        dotsWrap.className = 'dots';
        function updateDots() {
            dotsWrap.querySelectorAll('.dot').forEach((dot,i)=> dot.classList.toggle('active', i===imgIdx));
        }
        offer.productImages.forEach((u,i)=>{
            const dot = document.createElement('span');
            dot.className = 'dot'+(i==imgIdx?' active':'');
            dot.onclick = ()=> { imgIdx=i; img.src = u; updateDots();}
            dotsWrap.appendChild(dot);
        });
        carousel.appendChild(dotsWrap);
        const now = new Date();
        if (offer.offerType && offer.offerType.startsWith('discount')) {
            let b='';
            if(offer.offerType==='discountPercent') b='-'+offer.offerValue+'%';
            else if(offer.offerType==='discountFixed') b='-'+(offer.productPriceCurrencySymbol||'£')+offer.offerValue;
            else if(offer.offerType==='discountCredit') b='+'+(offer.productPriceCurrencySymbol||'£')+offer.offerValue;
            if(b) {
                const badge = document.createElement('span');
                badge.className = 'badge';
                badge.textContent = b;
                carousel.appendChild(badge);
            }
        } else if (offer.offerType==='freeProduct') {
            const badge = document.createElement('span');
            badge.className = 'badge';
            badge.textContent = 'FREE';
            carousel.appendChild(badge);
        }
        if(offer.expireAt){
            const exp = new Date(offer.expireAt);
            if(exp>now){
                let text = '';
                const mins = Math.floor((exp-now)/60e3), hours=Math.floor((exp-now)/36e5),days=Math.floor((exp-now)/864e5);
                if(mins<60) text = 'Ends in '+mins+' min';
                else if(hours<24) text = 'Ends in '+hours+' h';
                else text = 'Ends in '+days+' d';
                const badge = document.createElement('span');
                badge.className = 'expire';
                badge.textContent = text;
                carousel.appendChild(badge);
            }
        }
        card.appendChild(carousel);
        const head = document.createElement('div');
        head.className = 'offer-header';
        head.innerHTML = `<span class="offer-title">${offer.productName}</span>`
        if (offer.rating>0)
            head.innerHTML += `<span class="offer-rating">★ ${offer.rating.toFixed(1)} <span style="color:#888;">(${offer.reviewCount||0})</span></span>`;
        card.appendChild(head);
        const desc = document.createElement('div');
        desc.className = 'offer-desc';
        desc.textContent = offer.productDescription? offer.productDescription.replace(/<\/?[^>]+(>|$)/g, "") : '';
        card.appendChild(desc);
        const priceBox = document.createElement('div');
        priceBox.className = 'offer-price';
        let showOld = false;
        let final = offer.productPrice, orig = offer.productPrice;
        if (offer.offerType==='discountPercent') {
            final = orig*(1-offer.offerValue/100); showOld = true;
        } else if (offer.offerType==='discountFixed') {
            final = orig-offer.offerValue; showOld = true;
        } else if (offer.offerType==='freeProduct') {
            final = 0; showOld = true;
        }
        priceBox.textContent = (offer.productPriceCurrencySymbol||'£')+final.toFixed(2);
        if (showOld) priceBox.innerHTML += `<span class="offer-oldprice">${(offer.productPriceCurrencySymbol||'£')}${orig.toFixed(2)}</span>`;
        card.appendChild(priceBox);
        const actions = document.createElement('div');
        actions.className = 'offer-action';
        const buyBtn = document.createElement('button');
        buyBtn.className = 'buy-btn';
        buyBtn.textContent = 'Buy now';
        buyBtn.onclick = ()=> { window.open(offer.offerUrl,'_blank'); }
        actions.appendChild(buyBtn);
        const nextBtn = document.createElement('button');
        nextBtn.className = 'next-btn';
        nextBtn.textContent = 'Next Offer';
        nextBtn.onclick = ()=> { offerIdx = (offerIdx+1)%offers.length; show(offerIdx);}
        actions.appendChild(nextBtn);
        card.appendChild(actions);
        wrapper.appendChild(card);
    }
    show(offerIdx);
    return wrapper;
}
document.getElementById('recForm').onsubmit = async function(e){
    e.preventDefault();
    const email = this.email.value, orderId = this.orderId.value, sku = this.sku.value;
    const data = {
        "products": [ { "sku": sku, "skuBase": sku, "quantity": 1, "price": 512.07, "discount": 10 } ],
        "orderId": orderId,
        "email": email
    };
    document.getElementById('output').innerHTML = "Loading...";
    try {
        const resp = await fetch(
            'https://services-staging.stacktome.com/api/recommendations/v1/recommendations/offers?apikey=fSKNKExtPdLC8YFXbXH80euskf6SVcR8',
            { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) }
        );
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        const json = await resp.json();
        const offers = json.offers;
        document.getElementById('output').innerHTML = '';
        document.getElementById('output').appendChild(renderOffers(offers));
    } catch(err){
        document.getElementById('output').innerHTML = 'Error: '+err;
    }
};
</script>
</body>
</html>
